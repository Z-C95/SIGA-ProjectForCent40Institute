{% load static %}

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}SIGA — Plataforma{% endblock %}</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- CSS propio -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body class="{% if request.COOKIES.dark_mode == 'true' %}dark-mode{% endif %}">

  <!-- NAVBAR SUPERIOR -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid d-flex justify-content-between align-items-center">

      <!-- LOGO SIGA redirige al home -->
      <a class="navbar-brand brand" href="{% url 'asistencias:home' %}">
        SIGA
      </a>

      <!-- LADO DERECHO DEL NAVBAR -->
      <div class="d-flex align-items-center gap-2">

        <!-- Botón modo oscuro (manejado por JS + cookie) -->
        <button id="darkModeToggle" type="button" class="btn btn-outline-light btn-sm">
          Modo oscuro
        </button>

        {% if request.user.is_authenticated %}

          <!-- Texto de bienvenida -->
          <span class="navbar-text me-2 d-none d-sm-inline">
            Hola, {{ request.user.first_name|default:request.user.username }}
          </span>

          <!-- Botón Perfil -->
          <a href="{% url 'asistencias:editar_perfil' %}" class="btn btn-outline-light btn-sm">
            Perfil
          </a>

          <!-- BOTÓN DE CERRAR SESIÓN - POST + CSRF (Django 5 compatible) -->
          <form method="post"
                action="{% url 'asistencias:logout' %}"
                class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-sm">
              Cerrar sesión
            </button>
          </form>

        {% else %}

          <!-- Si no está logueado, mostrar botón de login -->
          <a href="{% url 'login' %}" class="btn btn-outline-light btn-sm">
            Iniciar sesión
          </a>

        {% endif %}

      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">

      {% if request.user.is_authenticated %}
        <!-- SIDEBAR IZQUIERDO -->
        <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse show" id="sidebarMenu">
          <div class="position-sticky pt-3 sidebar-sticky">

            <ul class="nav flex-column mb-3">

              <!-- Siempre disponible -->
              <li class="nav-item">
                <a class="nav-link" href="{% url 'asistencias:home' %}">
                  Inicio
                </a>
              </li>

              {% if request.user.is_staff or request.user.rol == "ADMIN" %}
                <li class="nav-item">
                  <a class="nav-link" href="{% url 'asistencias:admin_dashboard' %}">
                    Dashboard Admin
                  </a>
                </li>

                <li class="nav-item">
                  <a class="nav-link" href="{% url 'asistencias:usuarios_lista' %}">
                    Usuarios
                  </a>
                </li>

                <li class="nav-item">
                  <a class="nav-link" href="{% url 'asistencias:carreras_lista' %}">
                    Carreras
                  </a>
                </li>

                <li class="nav-item">
                  <a class="nav-link" href="{% url 'asistencias:materias_lista' %}">
                    Materias
                  </a>
                </li>

                <li class="nav-item">
                  <a class="nav-link" href="{% url 'asistencias:admin_cursadas' %}">
                    Cursadas
                  </a>
                </li>

                <li class="nav-item">
                  <a class="nav-link" href="{% url 'asistencias:lista_justificativos' %}">
                    Justificativos
                  </a>
                </li>

                <li class="nav-item">
                  <a class="nav-link" href="{% url 'asistencias:reportes_curso' %}">
                    Reportes
                  </a>
                </li>

                <li class="nav-item">
                  <a class="nav-link" href="{% url 'asistencias:admin_metricas' %}">
                    Métricas Admin
                  </a>
                </li>

              {% elif request.user.rol == "DOCENTE" %}
                <li class="nav-item">
                  <a class="nav-link" href="{% url 'asistencias:docente_dashboard' %}">
                    Panel docente
                  </a>
                </li>

                <li class="nav-item">
                  <a class="nav-link" href="{% url 'asistencias:cursos_docente' %}">
                    Mis cursos
                  </a>
                </li>

                <li class="nav-item">
                  <a class="nav-link" href="{% url 'asistencias:docente_metricas' %}">
                    Métricas
                  </a>
                </li>

              {% elif request.user.rol == "ALUMNO" %}
                <li class="nav-item">
                  <a class="nav-link" href="{% url 'asistencias:alumno_dashboard' %}">
                    Mi panel
                  </a>
                </li>

                <li class="nav-item">
                  <a class="nav-link" href="{% url 'asistencias:consulta_asistencia' %}">
                    Mis asistencias
                  </a>
                </li>

                <li class="nav-item">
                  <a class="nav-link" href="{% url 'asistencias:subir_certificado' %}">
                    Subir justificativo
                  </a>
                </li>

                <li class="nav-item">
                  <a class="nav-link" href="{% url 'asistencias:alumno_metricas' %}">
                    Métricas
                  </a>
                </li>

              {% endif %}
            </ul>

          </div>
        </nav>

        <!-- CONTENIDO PRINCIPAL SI ESTÁ AUTENTICADO -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">

      {% else %}

        <!-- SIN LOGIN: CONTENIDO A ANCHO COMPLETO -->
        <main class="col-12 px-3 py-4">

      {% endif %}

        {% block content %}
        {% endblock %}

      </main>

    </div>
  </div>

  <!-- FOOTER -->
  <footer class="text-center py-3 mt-4 border-top small">
    Sistema de Gestión Académica — Módulo de Asistencias · CENT 40
  </footer>

  <!-- JS Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- JS propio -->
  <script src="{% static 'js/main.js' %}"></script>

  <!-- Script Modo Oscuro: sincroniza botón, clase y cookie 'dark_mode' -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const toggle = document.getElementById('darkModeToggle');
      const body = document.body;

      if (!toggle) return;

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      function setCookie(name, value, days) {
        let expires = "";
        if (days) {
          const date = new Date();
          date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
          expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
      }

      // Estado inicial según cookie
      const darkCookie = getCookie('dark_mode');
      if (darkCookie === 'true') {
        body.classList.add('dark-mode');
      }

      toggle.addEventListener('click', function () {
        const isDark = body.classList.toggle('dark-mode');
        setCookie('dark_mode', isDark ? 'true' : 'false', 365);
      });
    });
  </script>

</body>
</html>
